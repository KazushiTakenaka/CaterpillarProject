# ESP32 ラジコン 受信側 (総従物)

## 概要

このプロジェクトは、ESP32 マイコンボードを使用して、ラジコンカーの受信側 (総従物) のコードを構築します。ESP-NOW プロトコルを用いて送信側 (コントローラー) からのデータを受信し、モーターの制御、ライトの点灯、ブザーの動作などを実行します。

## ファイル構成

プロジェクトのファイル構成は以下の通りです。

* `platformio.ini`: PlatformIO プロジェクトの設定ファイル
* `src/`: ソースコードディレクトリ
    * `main.cpp`: メインのプログラムファイル。ESP-NOW の初期化、データ受信、モーター/ライト/ブザーの制御などを実行します。
    * `ESPNowManager.cpp`: ESP-NOW 通信の初期化、ペアリング処理を管理するクラスの実装
    * `ESPNowManager.h`: `ESPNowManager` クラスのヘッダーファイル
    * `Train.cpp`: モーター、ライト、ブザーを制御する `Train` クラスの実装
    * `Train.h`: `Train` クラスのヘッダーファイル
    * `Secret.cpp`: 送信側 ESP32 の MAC アドレスを定義 (実際の値はここに記述)
    * `Secret.h`: 送信側 ESP32 の MAC アドレスを定義するためのヘッダーファイル

## 動作

このプログラムは、以下の手順で動作します。

1.  **ESP-NOW の初期化**:

    * ESP-NOW を初期化し、送信側とのペアリングを行います。

2.  **データ受信**:

    * 送信側から ESP-NOW で送信されたデータを受信します。受信したデータは、`ReceivedDataPacket` 構造体に格納されます。

3.  **モーター制御**:

    * 受信したデータに基づいて、モーターの速度と方向を制御します。

4.  **ライト制御**:

    * 受信したデータに基づいて、ライトの点灯/消灯を制御します。

5.  **ブザー制御**:

    * 受信したデータに基づいて、ブザーの音を制御します。

6.  **通信断絶処理**:

    * 一定時間データを受信しない場合、通信が途絶えたと判断し、モーターを停止するなど、安全のための処理を行います。

## 準備するもの

このプロジェクトに必要なものは以下の通りです。

* ESP32 マイコンボード
* モーター
* モータードライバ
* ライト (LED)
* ブザー
* その他、ラジコンカーを製作するための部品

## セットアップ

1.  **PlatformIO のインストール**:

    * Visual Studio Code と PlatformIO IDE 拡張機能をインストールします。

2.  **プロジェクトのクローン**:

    * このリポジトリをクローンします。

3.  **MAC アドレスの設定**:

    * `src/Secret.cpp` に、送信側 (コントローラー) の ESP32 の MAC アドレスを記述します。

4.  **ライブラリのインストール**:

    * PlatformIO が、必要なライブラリを自動的にインストールします。

5.  **ビルドと書き込み**:

    * PlatformIO を使用して、コードをビルドし、ESP32 に書き込みます。

## ペアリング

* 受信側 ESP32 は、`src/Secret.cpp` に記述された MAC アドレスを持つ送信側 ESP32 とのみペアリングします。

* 送信側と受信側の電源を投入すると、自動的にペアリング処理が開始されます。

## コード説明

### `main.cpp`

* ESP-NOW の初期化、コールバック関数の登録、データ送受信処理を記述します。

* モーター、ライト、ブザーの制御を行います。

* 受信したデータの処理を行います。

### `ESPNowManager.cpp` / `ESPNowManager.h`

* ESP-NOW の初期化、ペアリング処理をカプセル化します。

* 送信側との接続を管理します。

### `Train.cpp` / `Train.h`

* モーターの制御 (前進、後進、停止) を行います。

* ライトの制御 (点灯、消灯) を行います。

* ブザーの制御 (音を鳴らす、止める) を行います。

* 走行音、サイレン音の再生機能を提供します。

### `Secret.cpp` / `Secret.h`

* 送信側 ESP32 の MAC アドレスを定義します。

* MAC アドレスは、送信側の ESP32 で `WiFi.macAddress()` を使用して確認できます。

## 注意事項

* ESP-NOW の通信距離は、環境によって大きく左右されます。

* 送信側と受信側の MAC アドレスを正しく設定しないと、通信できません。

* モータードライバの選定や配線は、使用するモーターに合わせて適切に行ってください。

## トラブルシューティング

* **通信ができない**:

    * 送信側と受信側の MAC アドレスが一致しているか確認してください。

    * ESP-NOW のチャンネル設定が一致しているか確認してください。

    * 通信距離が離れすぎていないか確認してください。

    * 電波干渉がないか確認してください。

* **モーターが動かない**:

    * モータードライバの配線を確認してください。

    * モータードライバの電源を確認してください。

    * コード内のピン設定が正しいか確認してください。

* **ライト、ブザーが動作しない**:

    * 配線を確認してください。

    * コード内のピン設定が正しいか確認してください。

## ライセンス

本ソフトウェアは、非商用かつ個人利用の目的でのみ使用が許諾されます。

商用利用、改変、複製、再配布、逆コンパイル、リバースエンジニアリング、逆アセンブル、その他、著作権者の権利を侵害する行為は禁止されています。

## 免責事項

著作権者は、本ソフトウェアの利用に関して、いかなる保証も行わないものとします。

本ソフトウェアの利用によって生じた損害について、著作権者は一切の責任を負わないものとします。

## 著作権

本ソフトウェアの著作権は、著作権者に帰属します。

## 著者

\[Kazushi Takenaka\]
